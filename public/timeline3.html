<!DOCTYPE html>
<html ng-app="SensorMappingApp">
   <head>
        <title>Visualization of Room</title>
		<meta charset="utf-8">
		<meta name="author" content="Steven Hassall && Sizhe Xi ">
		<meta name="description" content="Visualization of the sensor map">
	</head>
	<body style="background:black">
<style type="text/css">

div.tooltip {
  position: absolute;
  text-align: center;
  width: 60px;
  height: 12px;
  padding: 8px;
  font: 10px sans-serif;
  background: #ddd;
  border: solid 1px #aaa;
  border-radius: 8px;
  pointer-events: none;
}

path {
	stroke: steelblue;
	stroke-width: 1;
	fill: none;
}

.area {
    fill: lightsteelblue;
    stroke-width: 0;
}

</style>
		<section id="vis">
			<div class="content" ng-controller="mappingListCtrl">
				<div id="stations">
					<div id="map-wrapper"><svg class="map"></svg></div>
					<!--<div id="tiles-wrapper"><svg class="tiles"></svg></div></div>-->
				</div>			
			</div>
		</section>
		
		<div id="graph" class="aGraph" style="position:absolute;top:0px;left:0; float:left; width:300px; height:60px;"></div>
	
		<footer><div class="content"></div></footer>
        
		<script src="/assets/js/heatmap.js"></script>
        <script src="/assets/js/socket.io.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
	    <script src="/assets/js/angular.min.js"></script>
	    <script src="/js/underscore-min.js"></script>
        <script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>

	<script>


var SensormappingApp = angular.module('SensorMappingApp', []);
SensormappingApp.controller('mappingListCtrl', function ($rootScope,$scope, $http, $interval, socket) {
    
	$scope.sensors = [];
	var checkTimer ;
	
	var legend;
    var data = {};
	data.states= [{value:15,desc:'good'},{value:12,desc:'ok'},{value:9,desc:'not ok'},{value:6,desc:'bad'},{value:3,desc:'worse'}];	
	var dy = 25;
	var map ;
	
	$scope.initGrapth = function(){
	    console.log('init grapth');
	    legend = d3.select('svg.map').append('g').attr('class','legend').attr('transform', 'translate(450, 200)');
	    render();	
	}
		
	$scope.loadSensorData = function(){
        $http.get('/sensors/arm/').success(function(data) {
            $scope.sensors = data.sensors;
	        //console.log(data.sensors);
	        data.sensors.forEach(function(sensor){
	            console.log(sensor.name);
	        })
		    
        }).error(function(data, status, headers, config) {
                // called asynchronously if an error occurs
                // or server returns response with an error status.
        });
	}
	
	$scope.loadMapData =function(){
	    d3.csv('data/location-coord.csv', function(coord) {
		    for (var j = 0; j < coord.length; j++) {
                //console.log(coord[j].x,coord[j].y);
            }
			data.maps = coord;

			console.log('mapping loading  success',data.maps);
		})
	}
	
	$scope.initGrapth();
	$scope.loadSensorData();
	$scope.loadMapData();	
    checkTimer = $interval($scope.checkSensorTimer, 1000*60);
    $rootScope.$broadcast('mybroadcast');	
		
				
	$scope.$on('mybroadcast', function(service){
		console.log('on my broadcast', service);
    })
			
	$scope.checkSensorTimer = function(){
	    //console.log('check timer');
	}

    $scope.dateformat = function(date){
        var date = new Date(date);	
	   	var hour = date.getHours(), min = date.getMinutes();
		if(hour < 10) hour = '0'+date.getHours();
		if(min < 10) min = '0'+date.getMinutes();
        return  hour+":"+min;		 
	}
			
    socket.on('connect', function () {
	    console.log('socket connected');
    });
	
    socket.on('error', function (reason){
		stats.style("top","0px").select("div").text("Connecting...");				
		console.error('Unable to connect Socket.IO', reason);
	});	
                        
    socket.on('info', function (msg) {               
        //console.log(msg);
        console.log(msg.room,msg.value,msg.type)
        if(msg.type=='motion'){ 
            var room = _.findWhere($scope.rooms, {name: msg.room});	
			if(room){
                console.log('room  object  ',room);
                room.available = true;
			}	
        }
    });		
    function render(){	
	    console.log('render  ...');

	      	
	    legend.selectAll('text11').data(data.states).enter().append('text')
	        .attr('class', 'legend-element')
	        .attr('x',15)
	        .attr('y',function(e,i){return dy*i})      
	        .attr('dy', '.375em')	      
		    .transition()
            .duration(2500)
            .delay(function(d, i) { return i * 400; })
		    .text(function(e,i){  return e.desc;   });    	
	}

	$scope.$on('$destroy', function() {
        if (angular.isDefined(checkTimer)) {
            $interval.cancel(checkTimer);
            checkTimer = undefined;
        }
        socket.removeAllListeners();		
    });		
});

SensormappingApp.factory('socket', function ($rootScope) {
    if (!window.location.origin)
    window.location.origin = window.location.protocol+"//"+window.location.host;
    var socket = io.connect(window.location.origin+":3000",{'force new connection': true});
    return {
        on: function (eventName, callback) {
            socket.on(eventName, function () {  
            var args = arguments;
            $rootScope.$apply(function () {
                callback.apply(socket, args);
            });
        });
    },
        emit: function (eventName, data, callback) {
            socket.emit(eventName, data, function () {
            var args = arguments;
            $rootScope.$apply(function () {
                if (callback) {
                    callback.apply(socket, args);
                }
            });
        })
    }
  };
});
	



  



</script>
    </body>
</html>




