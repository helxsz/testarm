<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" ng-app="SensorMappingApp"> <!--<![endif]-->
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>ARM Dashboard Heatmap App</title>
	<meta name="author" content="Steven Hassall and Sizhe Xi ">
	<meta name="description" content="ARM Dashboard Sensor Monitoring Project">
    <meta name="viewport" content="width=device-width, maximum-scale=1, minimum-scale=1, user-scalable=0, initial-scale=1">
    
    <!-- Gridset CSS   <link rel="stylesheet" href="css/gridset.css"> -->
    <!--[if (!IE) | (gt IE 9)]><!--><!--<![endif]-->
    <!--[if IE 9]><link rel="stylesheet" href="./css/gridset-ie-9.css" /><![endif]-->
    <!--[if lte IE 8]><link rel="stylesheet" href="./css/gridset-ie-lte8.css" /><![endif]       -->
    <link rel="stylesheet" href="css/mfglabs_iconset.css">
    <link rel="stylesheet" href="css/menu-component.css">
    <link rel="stylesheet" href="css/normalize.min.css">
    <link rel="stylesheet" href="css/main.css">

	<script src="js/vendor/underscore-min.js"></script>			
	<script src="/assets/js/heatmap.js"></script>
    <script src="/assets/js/socket.io.js"></script>
    <script src="/assets/js/d3.v3.min.js"></script>
	<script src="/assets/js/angular.min.js"></script>
	<script src="/js/underscore-min.js"></script>
    <script src="js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
</head>
<body>
<!--[if lt IE 7]>
    <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
<![endif]-->

    <div class="heatmap">
    <!-- START .meeting-room -->

        <div id="container" class="container" class="clearfix" ng-controller="mappingListCtrl">
        <!-- START #container -->

            <section class="mp-pusher" id="mp-pusher">

            	<!-- mp-menu -->
                    <nav id="mp-menu" class="mp-menu" > 
                        <div class="mp-level">
                            <button id="triggerMobile" class="mp-close d-hide t-hide"><i class="icon-cancel_circle icon2x"></i></button>
                            <h2><i class="icon-data_science blue"></i> ARM Buildings</h2>
                            <ul>

                                <li>
                                    <a href="#">ARM 1</a>
                                    <div class="mp-level">
                                        <h2><i class="icon icon-data_science_black blue"></i> ARM 1</h2>
                                        <a class="mp-back" href="#">back</a>
                                        <ul>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/ARM1/0">Ground</a></li>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/ARM1/1">Floor 1</a></li>
                                        </ul>
                                    </div>
                                </li>
                                <li>
								    <a href="#">ARM 2</a>
                                    <div class="mp-level">
                                        <h2><i class="icon icon-data_science_black blue"></i> ARM 2</h2>
                                        <a class="mp-back" href="#">back</a>
                                        <ul>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/ARM2/0">Ground</a></li>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/ARM2/1">Floor 1</a></li>
                                        </ul>
                                    </div>									
								</li>
                                <li>
								    <a href="#">ARM 3</a>
                                    <div class="mp-level">
                                        <h2><i class="icon icon-data_science_black blue"></i> ARM 3</h2>
                                        <a class="mp-back" href="#">back</a>
                                        <ul>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/ARM3/0">Ground</a></li>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/ARM3/1">Floor 1</a></li>
                                        </ul>
                                    </div>									
								</li>
                                <li>
								    <a href="#">ARM 6</a>
                                    <div class="mp-level">
                                        <h2><i class="icon icon-data_science_black blue"></i> ARM 6</h2>
                                        <a class="mp-back" href="#">back</a>
                                        <ul>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/ARM6/0">Ground</a></li>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/ARM6/1">Floor 1</a></li>
                                        </ul>
                                    </div>									
								</li>
                                <li>
								    <a href="#">CPC1</a>
                                    <div class="mp-level">
                                        <h2><i class="icon icon-data_science_black blue"></i> CPC1 </h2>
                                        <a class="mp-back" href="#">back</a>
                                        <ul>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/CPC1/0">Ground</a></li>
                                            <li><a class='room_nav' ng-click="getRoomInfo($event.target.href);$event.preventDefault()" href="/buildings/CPC1/1">Floor 2</a></li>
                                        </ul>
                                    </div>									
								</li>
                                 								
                            </ul>
                                
                        </div>
                    </nav>
                    <!-- /mp-menu -->

                <div class="scroller">
                <div class="scroller-inner">
                <!-- start .scroller's -->
                
                <div class="wrapper">
                <!-- START .wrapper -->

                    <header id="banner" class="d1-d9 t1-t4 m-all clearfix" >
                    <!-- START #banner -->
                        <button id="trigger" onclick="_gaq.push(['_trackEvent', 'Menu', 'Toggle', 'Menu Toggle',, false]);"><i class="icon-reorder icon2x"></i></button>
                        <h1 ng-cloak>{{current_building}} <span class="blue" ng-cloak> {{current_floor}} FLOOR</span> LIVE <span class="pink">HEAT</span> MAP</h1>
                    <!-- END #banner -->
                    </header>

                    <article id="main" class="d1-d4 t1-t3 m-all clearfix">
                    <!-- START #main -->
                        <div id="app-brand" class="m-hide" ng-click="room.front = !room.front" ng-class="{'flipped': room.front}">
                            <div class="ch-item" >              
                                <div class="ch-info-wrap">
                                    <div class="ch-info meetings">
                                        <div class="ch-info-front hexagon"></div>
                                        <div class="ch-info-back hexagon">
                                            <a href="http://arm.redninja.co.uk" title="Return to the Home">
                                                <i class="icon-home icon3x" aria-hidden="true"></i>
                                                <h3>Home</h3>
                                            </a>
                                        </div>  
                                    </div>
                                </div>
                            </div>
                        </div>

                        <article id="app-description" class="t-hide m-hide" role="article">
                          <p>Please email any feedback to <a href="mailto:arm@redninja.co.uk" title="Email Feedback">arm@redninja.co.uk</a>.</p>
                          <!-- <p><a href="#popup-key" ng-click="openkey();" title="View Key" class="button">View Key</a></p> -->
                        </article>   
                    
                    <!-- END #main -->
                    </article>

                    <section id="app-heat" class="app-content clearfix">				
	                <!-- START #app-energy -->

	                	<aside id="app-description" class="d1-d3 t1-t3 m-all">

	                        <ul>
	                        	<li>22 +</li>
	                        	<li>19 - 21</li>
	                        	<li>- 18</li>
	                        </ul>
							
							<section id="vis">
								<div class="content" >
									<div id="stations">
										<div id="map-wrapper"><svg class="map"></svg> <div id="map"> </div></div>
										<!--<div id="tiles-wrapper"><svg class="tiles"></svg></div></div>-->
									</div>			
								</div>
							</section>
							

	                    </aside>

					<!-- END #app-energy -->
					</section>

                <!-- END .wrapper -->
                </div>
                

				<footer id="footer" class="clearfix">
				<!-- START #footer -->

				  <div>
				      <small>v0.1 Design &amp; Coded by <a href="http://www.redninja.co.uk" title="Design and Coded by Red Ninja Studios">Red Ninja Studios</a></small>
				  </div>

				  <div>
				      <a href="http://arm.com" class="logo-arm" title="ARM - Architecture for the digital world"><img src="img/ARM-RGB.png" alt="ARM - Architecture for the digital world" class="logo" /></a>
				  </div>

				<!-- END #footer -->
				</footer>

                <!-- end .scroller's -->
                </div>
                </div>

            </section>

        <!-- END #container -->
        </div>
    <!-- END .meeting-room -->
    </div>

    <script src="js/vendor/jquery-1.10.1.min.js"></script>
    <script src="js/plugins.js"></script>
    <script src="js/vendor/classie.js"></script>
    <script src="js/vendor/mlpushmenu.js"></script>
	
	<script>
var SensormappingApp = angular.module('SensorMappingApp', []);
SensormappingApp.controller('mappingListCtrl', function ($rootScope,$scope, $http, $interval, socket) {
		$scope.loading = false;
		$scope.rooms = [];
		$scope.buildings = [];
		
		$scope.current_building = "ARM3";
		$scope.current_floor = "GROUND";   
        $scope.current_floor_index = 0;
		
		$scope.sensors = [];
		var checkTimer ;
		
		var legend;
		var data = {};
		data.states= [{value:15,desc:'good'},{value:12,desc:'ok'},{value:9,desc:'not ok'},{value:6,desc:'bad'},{value:3,desc:'worse'}];	
		var dy = 25;
		var map ;
		
		$scope.initGrapth = function(){
			console.log('init grapth');
			legend = d3.select('svg.map').append('g').attr('class','legend').attr('transform', 'translate(450, 200)');
			//render();	
		}
			
		$scope.loadSensorData = function(){
			$http.get('/sensors/arm/').success(function(data) {
				$scope.sensors = data.sensors;
				//console.log(data.sensors);
				data.sensors.forEach(function(sensor){
					//console.log(sensor.name);
				})
				
			}).error(function(data, status, headers, config) {
					// called asynchronously if an error occurs
					// or server returns response with an error status.
			});
		}
	var svg = d3.select('svg.map');	
	var offset_x = 550, offset_y = 250;
    var floor = svg.append("svg:g").attr('id','floor');
	var sensorLayer = svg.append('svg:g').attr('id','sensorLayer');

	/******************  tooltip ******************************/
	var tooltip = d3.select("body").append("div")
	                               .attr("class", "tooltip")
								   .style("opacity", 0);
	var offsety = 200;
	
var BuildingMap = function() {
	var map = {};

	var color = d3.scale.linear()
		.domain([95, 115, 135, 155, 175, 195])
		.range(["#0a0", "#6c0", "#ee0", "#eb4", "#eb9", "#fff"]);	
		


	////////////////////////////////////////
	function addFloor(building,floor){
		
		svg.append("svg:g")
		   .attr("transform", "translate(" + (offset_x/2 ) + "," + (offset_y/2) + ")")  //
		   .append("svg:rect")
			.attr("width", 680)
			.attr("height", 340)
			.style("stroke", "#134D61")
			.style("fill", "#092630")
			.on("mouseover", mouseover)
			.on("mousemove", mousemove)
			.on("mouseout", mouseout)
			.on("click", click)
			
		var div = d3.select("body").append("div").attr("class", "tooltip").style("opacity", 1e-6);
		function mouseover() {
		  div.transition()
			  .duration(500)
			  .style("opacity", 1);
		}

		function mousemove() {
		  div.text(d3.event.pageX + ", " + d3.event.pageY)
			 .style("left", (d3.event.pageX - 34) + "px")
			 .style("top", (d3.event.pageY - 12) + "px");
		}

		function mouseout() {
		  div.transition()
			 .duration(500)
			 .style("opacity", 1e-6);
		}	

		function click(){
		  // Ignore the click event if it was suppressed
		  if (d3.event.defaultPrevented) return;
		  
		  // Extract the click location\    
		  var point = d3.mouse(this) , p = {x: point[0], y: point[1] };
		 
		  console.log(p.x, p.y);
		  // Append a new point
		  svg.append("circle")
			  .attr("transform", "translate(" + (offset_x +p.x) + "," + (offset_y +p.y) + ")")  //scale(2)
			  .attr("r", "5")
			  .attr("class", "dot")
			  .style("cursor", "pointer")
			  .call(drag);
		  d3.event.stopPropagation();	  
		}
			
		// Define drag beavior
		var drag = d3.behavior.drag()
			.on("drag", dragmove);

		function dragmove(d) {
		   var x = d3.event.x;
		   var y = d3.event.y;
		   d3.select(this).attr("transform", "translate(" + x + "," + y + ")");
		}
	}	

	function addSensors(){
		/*
		Primary Blue:       #2599C1;
		Mid Blue:           #134D61;
		Dark Blue:          #092630;

		Primary Pink:       #CE1D6F;
		Mid Pink:           #9B1653;
		Dark Pink:          ;	
		
		*/
		  // Append a sensor point
		var sensors = [
			{x:170 , y:140  , t:18},
			{x:10 , y:240 , t:4},
			{x:60 , y:150 , t:27},
			{x:30 , y:120 , t:27}		
		]; 	  
			
		svg.selectAll('circle111').attr("transform", "translate(" + (offset_x ) + "," + (offset_y) + ")rotate(-15)")
			.data(sensors)
			.enter()		
			.append('circle')
			.on( "mousedown", function() {
				if( !d3.event.ctrlKey) d3.selectAll( '.selected').classed( "selected", false);
				console.log("mouse down");
				var p = d3.mouse( this);
				svg.append( "rect")
					.attr({
						rx      : 6,
						ry      : 6,
						class   : "selection",
						x       : p[0],
						y       : p[1],
						width   : 0,
						height  : 0
					})
			})		
			.attr('cx',function(e,i){return offset_x +e.x})
			.attr('cy',function(e,i){ return offset_y+e.y})
			.attr('r',function(e){
				return e.t * 2
			})
			.on( "mouseup", function() { 
				svg.selectAll( "rect.selection").remove();
				d3.selectAll( '.selection').classed( "selection", false);
			})
			.style('fill', function(e,i) {
				return "#620F3a" ;
			})

		var sensor = svg.selectAll('circle111').attr("transform", "translate(" + (offset_x ) + "," + (offset_y) + ")rotate(-15)")
			.data(sensors)
			.enter()
			.append('circle')
			.attr('cx',function(e,i){return offset_x +e.x})
			.attr('cy',function(e,i){ return offset_y+e.y})
			.attr('r',function(e){
				return e.t
			})
			.attr("class", "dot")
			.on('mouseover', function(d) { 
				d3.select(this)
				  .attr('fill', function(d) { return d3.rgb(d.color).brighter() })
				  .transition()
				  .attr('r', 24*2)
			  })
			.on('mouseout', function(d) {
				d3.select(this)
				  //.attr('fill', 'white')
				  .transition()
				  .attr('r', 24)
			  })    		  
			.style("cursor", "pointer")
			.transition()
			.style('fill', function(e,i) {
				if(e.t<=15) 
				return "#670F38" ;
				else if(e.t>=16 && e.t<=22)
				return "#9B1653";
				else if(e.t> 23)
				return "#CE1D6F";
			})
			.style("opacity",0.6);
	}


		// draw legend
	function showLegend() {
	  var dy = 36;
	  var mapLegend = d3.select('svg.map')
		.append('g')
		  .attr('class', 'legend')
		  .attr('transform', 'translate(150, 500)');
	  var legendData = [
		{
		  value: 19,
		  desc: '23 - 30',
		  color: ' #CE1D6F'
		},
		{
		  value: 17,
		  desc: '15 -22',
		  color: ' #9B1653'
		},
		{
		  value: 15,
		  desc: '1 - 14',
		  color: ' #670F38'
		}
	  ];
	  mapLegend.selectAll('circle.legend-element')
		.data(legendData)
		.enter().append('circle')
		  .attr('class', 'legend-element')
		  .attr('cx', 0)
		  .attr('cy', function(d, i) {
			return i * dy;
		  })
		  .attr('r', function(d) {
			return d.value;
		  })
		  .style('fill', function(e,i) {
				return e.color;
		  });
	  mapLegend.selectAll('text.legend-element')
		.data(legendData)
		.enter().append('text')
		  .attr('class', 'legend-element')
		  .attr('x', 20)
		  .attr('y', function(d, i) {
			return i * dy;
		  })
		  .attr('dy', '.375em')
		  .text(function(d) {
			return d.desc;
		  })
		  .style("stroke", "#134D61");
	};


    return {
	    addFloor:addFloor,
		addSensors:addSensors,
		showLegend:showLegend
	};
};
		
		$scope.loadRecent = function(){
			$scope.loading = true;
			$http.get('/buildings/'+$scope.current_building+'/'+$scope.current_floor_index+'/cache').success(function(data) {
				$scope.loadRoomData(data);
				$scope.loading = false;			
			}).error(function(data, status, headers, config) {
				$scope.loading = false;
			});				
		}		
		
		$scope.loadMapData =function(){
				var building = new BuildingMap();
				//building.addFloor($scope.current_building,$scope.current_floor_index);   not used
		        //building.addSensors();	
		        //building.showLegend();			
			//////////////////////////////////////////////////////////					
				d3.xml("/buildings/map?building="+$scope.current_building+'&floor='+$scope.current_floor_index, "image/svg+xml", function(xml) {
				//d3.xml("rect01.svg", "image/svg+xml", function(xml) {
					var importedNode = document.importNode(xml.documentElement, true);		   
					document.getElementById('floor').appendChild(importedNode.cloneNode(true));
					
					//d3.select('#rect1').attr('fill','blue');
                    // make map smaller					
					d3.select('#floor')
					    .attr("transform"," rotate(0) ")
					    .transition()
					    .ease("elastic")
				        .duration(800)
						.attr("transform","scale(0.5) rotate(-5) translate(0,"+offsety+")")
                    $scope.loadRecent();					
				});
			/////////////////////////////////////////////////////////////	
		}
		
		$scope.getRoomInfo = function(href){
		    //console.log('get room info',href);		
			$scope.menu_open = false;
			$scope.loading = true;
			
			var arr = href.split('/');
			console.log(arr);
			$scope.current_building = arr[4];
			if(arr[5] == 0) 
			$scope.current_floor = 'GROUND';
			else if(arr[5]==1)
			$scope.current_floor = 'FIRST';
			else if(arr[5]==2)
			$scope.current_floor = 'SECOND';
			
			$http.get(href).success(function(data) {
				     $scope.loadRoomData(data);
		
				
                $scope.loading = false;				
            }).error(function(data, status, headers, config) {
                $scope.loading = false;
            });
		}   
		// ARM33G21BIRCH_1_
		$scope.loadRoomData = function(data){
			    //console.log('loading ',data);
				$scope.loading = true;
				
				var sensors1 = [				
				]; 
				
				data.rooms.forEach(function(room){
				    if(room.t_enabled){
					    console.log(room.name,' ^^^: ', room, room.time,room.sensor,room.temperature);
					}
                    if(room.temperature == 0) room.temperature = 21.5;
					var second_name = room.name.split('.')[1].toUpperCase();			
					//console.log(room.name,second_name);							
					var circle = d3.selectAll('#'+second_name).append("circle").attr("cx", 725).attr("cy", 725).attr("r", 20 ).style("fill", '#f00');
					try{
					        var roomsvg = d3.select('#'+second_name);
							var x = roomsvg.attr('x'), y = roomsvg.attr('y'), width = roomsvg.attr('width'), height = roomsvg.attr('height');
							if(x !=null && y != null){
                                console.log('second_name  location ---------',d3.select('#'+second_name).attr('x'),d3.select('#'+second_name).attr('y'), width, height);
                                var posx = Number(x)+Number(width)/2, posy = Number(y)+Number(height)/2;	
                                sensors1.push({x:(posx),y:(posy),t:room.temperature,name:second_name, time:room.time});								
							}else {
							    var points = d3.select('#'+second_name).attr('points');
							    if(points !=null){
								    console.log('second_name  location points ',points);
									var temps = [], posx = 0, posy = 0;
									temps = points.split(' ');
									console.log('..................................',temps);
									temps.forEach(function(e){
									   // console.log(e);
										var arr = e.split(',');
										posx += Number(arr[0]), posy +=Number(arr[1]);
									})
									posx = posx/temps.length , posy = posy/temps.length;
									sensors1.push({x:(posx),y:(posy),t:room.temperature,name:second_name, time:room.time});
                                }								
							}
                            //d3.select('#'+second_name).attr("fill", "red");	                                               
                       }catch(e){
					        //console.error(e);
						}						  				
				})
                var offset_x = 0, offset_y = 0;
	
	           //var room_sensor = sensorLayer.append('svg:g').data(sensors1).attr('id',function(d,i){return d.name;}).attr("transform", "translate(" + (offset_x ) + "," + (offset_y) + ")");
	
                var place = sensorLayer.selectAll('.place').attr("transform", "translate(" + (offset_x ) + "," + (offset_y) + ")")
					.data(sensors1)
				place.exit().remove();	
				place.enter()		
					.append('circle')
                    .attr('class',function(d,i){  return 'place place-'+d.name;})						
					.attr('cx',function(e,i){ console.log('senosr  ',e.x,e.y);  return offset_x +e.x/2})
					.attr('cy',function(e,i){ return offset_y+e.y/2})
					.attr("transform", "rotate(-5) translate(0,"+offsety/2+")")
					.transition()
					.delay(1000)
					.ease("elastic")
				    .duration(800) 
					.attr('r',function(e){
						return e.t *2
					})
					.style("fill-opacity", function(d,i){
				        return 0.8;                                        
			        })
					.style('fill', function(e,i) {
						return "#620F3a" ;
					})

				place.on("mouseover", function(d) {
                    console.log('on mouse over ---- ',d.name,  (d3.event.pageX)/2,  (d3.event.pageY - 28)/2 , d.x/2, d.y/2);
                    d3.selectAll('.motion-'+d.name)
					        .transition()
					        .delay(800)
					        .ease("elastic").attr('r',function(e){
						        return Number(e.t) +2; 
					        })					
                }).on("mouseout", function(d) { 
                    console.log('on mouse out  ---',d.name);
                    d3.selectAll('.motion-'+d.name)
					        .transition()
					        .delay(800)
					        .ease("elastic").attr('r',function(e){
						        return Number(e.t)-4; 
					        })                    
				});					
					
				/////////////////////////////////////////////////////////////////////
				
				var sensor = sensorLayer.selectAll('.motion').attr("transform", "translate(" + (offset_x ) + "," + (offset_y) + ")")
					.data(sensors1)
				sensor.exit().remove();	
				sensor.enter()		
					.append('circle') 
                    .attr('class',function(d,i){  return 'motion motion-'+d.name;})					
					.attr('cx',function(e,i){ console.log('senosr  ',e.x,e.y);  return offset_x +e.x/2})
					.attr('cy',function(e,i){ return offset_y+e.y/2})
					.attr("transform", "rotate(-5) translate(0,"+offsety/2+")")
					.transition()
					.delay(1000)
					.ease("elastic")
				    .duration(800) 
					.attr('r',function(e){
						return Number(e.t) -4
					})
					.style('fill', function(e,i) {
						if(e.t<=15) 
						return "#670F38" ;
						else if(e.t>=16 && e.t<=22)
						return "#9B1653";
						else if(e.t> 23)
						return "#CE1D6F";
					})
					.style("fill-opacity", function(d,i){
				        return 0.8;                                        
			        });
				/*					
				sensor.on("mouseover", function(d) {
                    console.log('on mouse over ',d.name,  (d3.event.pageX)/2,  (d3.event.pageY - 28)/2 , d.x/2, d.y/2);				
					tooltip.transition()        
						.duration(200)      
						.style("opacity", .9);      
					tooltip.html("<br/>"+ d.name+"<br/>")  
						.style("left", (d3.event.pageX)/2 + "px")     
						.style("top", (d3.event.pageY - 28)/2 + "px");    
					})                  
				.on("mouseout", function(d) { 
                    console.log('on mouse out  ',d.name);				
					tooltip.transition()        
						.duration(500)      
						.style("opacity", 0);   
				});
				*/
				//////////////////////////////////////////////////////
				var label = sensorLayer.selectAll('.label').attr("transform", "translate(" + (offset_x ) + "," + (offset_y) + ")")
					.data(sensors1)
				label.exit().remove();	
				label.enter()		
					.append('text') 
                    .attr('class','label')					
					.attr('x',function(e,i){ console.log('label  ',e.x,e.y);  return offset_x +e.x/2+20})
					.attr('y',function(e,i){ return offset_y+e.y/2})
					.attr("transform", "rotate(-5) translate(0,"+offsety/2+")")
					.transition()
					.delay(1000)
					.ease("elastic")
				    .duration(800) 
                    .attr("dy", ".55em")
					.text(function(d) { return d.name; });;			
				
				
				$scope.rooms = data.rooms;			
		}		
					
		$scope.loadMapData();
        //$scope.initGrapth();		
		//checkTimer = $interval($scope.checkSensorTimer, 1000*60);
		$rootScope.$broadcast('mybroadcast');	
						
		$scope.$on('mybroadcast', function(service){
			console.log('on my broadcast', service);
		})
				
		$scope.checkSensorTimer = function(){
			//console.log('check timer');
		}

		$scope.dateformat = function(date){
			var date = new Date(date);	
			var hour = date.getHours(), min = date.getMinutes();
			if(hour < 10) hour = '0'+date.getHours();
			if(min < 10) min = '0'+date.getMinutes();
			return  hour+":"+min;		 
		}
				
		socket.on('connect', function () {
			console.log('socket connected');
		});
		
		socket.on('error', function (reason){
			//stats.style("top","0px").select("div").text("Connecting...");				
			console.error('Unable to connect Socket.IO', reason);
		});	
							
		socket.on('info', function (msg) {               
			//console.log(msg);
			if(msg.type=='motion'){ 
				var room = _.findWhere($scope.rooms, {name: msg.room});	
				  if(room){
					console.log('receiving the real time message from server ', msg.room,msg.value,msg.type, msg.time,room.time);
									
					if( new Date(room.time).getTime() < new Date(msg.time).getTime()){
						room.time = msg.time;
						room.available = true; 					
						//console.log('turn red');
						var name = msg.room.split('.')[1];						
						d3.selectAll('motion-'+name)
						    .transition()
					        .delay(800)
					        .ease("elastic")
							.attr('fill',function(e){
						        return "#670F38" ;
					        })
							
					
						d3.selectAll('.motion-'+name)
							.transition()
							.delay(800)
						    .ease("elastic").attr('fill',function(e){
								return "#9B1653";	 
							}) 						
						
						
					 }else{
						//console.log('room time',room.time.getTime());
						//console.log('>', msg.time.getTime());
					 }
				  }	
			}else if(msg.type =='temperature'){
				var room = _.findWhere($scope.rooms, {name: msg.room});	
				if(room!=null){
					console.log('receiving the real time message from server ', msg.room,msg.value,msg.type, msg.time,room.time)
					room.temperature = msg.value;
				}
			}else if(msg.type == 'online'){
				if(room!=null){
					console.log('receiving the real time message from server online', msg.room,msg.value,msg.type);
					if(msg.value==1)
					room.online = true;
					else if(msg.value == 0)
					room.online = false;
				}		
			}
		});

/*
    function render(){	
	    console.log('render  ...');	      	
	    legend.selectAll('text11').data(data.states).enter().append('text')
	        .attr('class', 'legend-element')
	        .attr('x',15)
	        .attr('y',function(e,i){return dy*i})      
	        .attr('dy', '.375em')	      
		    .transition()
            .duration(2500)
            .delay(function(d, i) { return i * 400; })
		    .text(function(e,i){  return e.desc;   });    	
	}
*/
	$scope.$on('$destroy', function() {
        if (angular.isDefined(checkTimer)) {
            $interval.cancel(checkTimer);
            checkTimer = undefined;
        }
        socket.removeAllListeners();		
    });		
});

SensormappingApp.factory('socket', function ($rootScope) {
    if (!window.location.origin)
    window.location.origin = window.location.protocol+"//"+window.location.host;
    var socket = io.connect(window.location.origin+":3000",{'force new connection': true});
    return {
        on: function (eventName, callback) {
            socket.on(eventName, function () {  
            var args = arguments;
            $rootScope.$apply(function () {
                callback.apply(socket, args);
            });
        });
    },
        emit: function (eventName, data, callback) {
            socket.emit(eventName, data, function () {
            var args = arguments;
            $rootScope.$apply(function () {
                if (callback) {
                    callback.apply(socket, args);
                }
            });
        })
    }
  };
});	
	
	</script>

    <!-- Gridset overlay script - toggles grid overlay on and off - You can remove this if you want. -->
    <script src="./js/gridset-overlay.js"></script> 

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-46398255-2', '54.194.94.166:80');
      ga('require', 'linkid', 'linkid.js');
      ga('send', 'pageview');

    </script>
</body>
</html>




